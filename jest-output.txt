FAIL tests/flow.test.js
  POST /agents/flow
    ✕ full successful flow using Responses API (84 ms)
    ✓ returns 400 when missing brief (5 ms)
    ✕ properly updates session status on completion and failure (6 ms)

  ● POST /agents/flow › full successful flow using Responses API

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "review the attached section draft (\"Front Cover\"", ["brief-file-id", "analysis-file-id", "questions-file-id", "customer_answers_initial-file-id", "Front_Cover_draft-file-id"], "QualityManager", "Phase3_ReviewSection_Front_Cover", "proposal-1748308691209"
    Received
           1
              "Analyze the provided customer brief thoroughly. Consider all aspects including business objectives, technical requirements, commercial aspects, and potential challenges. Provide a comprehensive assessment that will guide the proposal development process.",
              Array [
                "brief-file-id",
            -   "analysis-file-id",
            -   "questions-file-id",
            -   "customer_answers_initial-file-id",
            -   "Front_Cover_draft-file-id",
              ],
              "BriefAnalysis",
              "Phase1_BriefAnalysis",
              "proposal-1748308691209",
           2
              "Based on the brief and analysis, assign these sections: Front Cover, Executive Summary, Problem Statement, Proposed Solution, Project Deliverables, Project Timeline, Pricing, Case Studies and Testimonials, About Us, Next Steps, Appendices.···
    IMPORTANT: You must ONLY use these exact roles in your assignments: sp_Account_Manager, sp_Project_Manager, sp_Commercial_Manager, sp_Legal_Counsel, sp_Solution_Architect, sp_Data_Architect, sp_Lead_Engineer, sp_Quality_Manager, sp_Collaboration_Orchestrator·
    Return a JSON object mapping each section name to exactly one of these role names.",
              Array [
                "brief-file-id",
                "analysis-file-id",
            -   "questions-file-id",
            -   "customer_answers_initial-file-id",
            -   "Front_Cover_draft-file-id",
              ],
              "sp_Collaboration_Orchestrator",
              "Phase1_SectionAssignments",
              "proposal-1748308691209",
           3
              "As a Account_Manager, review the customer brief and generate 3-5 important strategic clarifying questions that would help you better understand the customer's needs and provide an expert proposal.······
    Your questions should:
    - Be relevant to your specific expertise and role
    - Focus on understanding business needs, constraints, and priorities
    - Cover different aspects of the project that need clarification
    - NOT ask how to write or structure the proposal
    - NOT ask section-specific questions
    - Demonstrate your expertise in your domain·
    Return your questions as a JSON array in this format:
    [
      {
        \"question\": \"Your first question text here\",
        \"rationale\": \"Brief explanation of why this question is important from your role's perspective\",
        \"category\": \"General topic/category for this question (e.g., 'Technical Requirements', 'Timeline', 'Business Objectives')\"
      },
      ...more questions...
    ]",
              Array [
                "brief-file-id",
                "analysis-file-id",
            -   "questions-file-id",
            -   "customer_answers_initial-file-id",
            -   "Front_Cover_draft-file-id",
              ],
              "sp_Account_Manager",
              "Phase1_ClarifyingQuestions",
              "proposal-1748308691209",

    Number of calls: 34

      356 |       for (const section of sections) {
      357 |         const draftFileId = flowData.sectionDrafts[section].fileId;
    > 358 |         expect(responsesAgent.createInitialResponse).toHaveBeenCalledWith(
          |                                                      ^
      359 |           expect.stringContaining(`review the attached section draft (\"${section}\"`),
      360 |           [flowData.briefFileId, flowData.analysisFileId, flowData.questionsFileId, flowData.customerAnswersFileId, draftFileId],
      361 |           "QualityManager",

      at Object.toHaveBeenCalledWith (tests/flow.test.js:358:54)

  ● POST /agents/flow › properly updates session status on completion and failure

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"completedAt": Any<Date>, "id": "test-session-id-1748308691247", "metadata": ObjectContaining {"finalReport": {"status": "completed"}}, "status": "completed"}

    Number of calls: 0

      542 |
      543 |       // Verify session.update was called with the right parameters for completion
    > 544 |       expect(Session.update).toHaveBeenCalledWith(
          |                              ^
      545 |         expect.objectContaining({
      546 |           id: sessionId,
      547 |           status: 'completed',

      at Object.toHaveBeenCalledWith (tests/flow.test.js:544:30)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 1 passed, 3 total
Snapshots:   0 total
Time:        1.049 s, estimated 2 s
Ran all test suites matching /tests\/flow.test.js/i.
