
> proposal-generator-v4@1.0.0 test
> jest --coverage --testPathPattern=flow.test.js

FAIL tests/flow.test.js
  POST /agents/flow
    ✕ full successful flow using Responses API (60 ms)
    ✓ returns 400 when missing brief (9 ms)

  ● POST /agents/flow › full successful flow using Responses API

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "generate 2-3 important strategic clarifying questions", ["brief-file-id", "analysis-file-id"], "sp_Account_Manager", Anything, Anything
    Received
           1
              "Analyze the provided customer brief thoroughly. Consider all aspects including business objectives, technical requirements, commercial aspects, and potential challenges. Provide a comprehensive assessment that will guide the proposal development process.",
              Array [
                "brief-file-id",
            -   "analysis-file-id",
              ],
              "BriefAnalysis",
              "Phase1_BriefAnalysis",
              "proposal-1748219004391",
           2
              "Based on the brief and analysis, assign these sections: Front Cover, Executive Summary, Problem Statement, Proposed Solution, Project Deliverables, Project Timeline, Pricing, Case Studies and Testimonials, About Us, Next Steps, Appendices.···
    IMPORTANT: You must ONLY use these exact roles in your assignments: sp_Account_Manager, sp_Project_Manager, sp_Commercial_Manager, sp_Legal_Counsel, sp_Solution_Architect, sp_Data_Architect, sp_Lead_Engineer, sp_Quality_Manager, sp_Collaboration_Orchestrator·
    Return a JSON object mapping each section name to exactly one of these role names.",
              ["brief-file-id", "analysis-file-id"],
              "sp_Collaboration_Orchestrator",
              "Phase1_SectionAssignment",
              "proposal-1748219004391",
           3
              "As a Account_Manager, review the customer brief and generate 3-5 important strategic clarifying questions that would help you better understand the customer's needs and provide an expert proposal.······
    Your questions should:
    - Be relevant to your specific expertise and role
    - Focus on understanding business needs, constraints, and priorities
    - Cover different aspects of the project that need clarification
    - NOT ask how to write or structure the proposal
    - NOT ask section-specific questions
    - Demonstrate your expertise in your domain·
    Return your questions as a JSON array in this format:
    [
      {
        \"question\": \"Your first question text here\",
        \"rationale\": \"Brief explanation of why this question is important from your role's perspective\",
        \"category\": \"General topic/category for this question (e.g., 'Technical Requirements', 'Timeline', 'Business Objectives')\"
      },
      ...more questions...
    ]",
              ["brief-file-id", "analysis-file-id"],
              "sp_Account_Manager",
              "Phase1_ClarifyingQuestions",
              "proposal-1748219004391",

    Number of calls: 34

      258 |
      259 |       // Clarifying Questions
    > 260 |       expect(responsesAgent.createInitialResponse).toHaveBeenCalledWith(
          |                                                    ^
      261 |         expect.stringContaining("generate 2-3 important strategic clarifying questions"), [flowData.briefFileId, flowData.analysisFileId], "sp_Account_Manager", expect.anything(), expect.anything()
      262 |       );
      263 |       expect(responsesAgent.createInitialResponse).toHaveBeenCalledWith(

      at Object.toHaveBeenCalledWith (tests/flow.test.js:260:52)

--------------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                                  | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
--------------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                             |    38.2 |    24.46 |   36.84 |   38.91 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
 proposal-generator-v4                |   32.86 |     19.8 |   20.58 |   34.81 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  index.js                            |   32.86 |     19.8 |   20.58 |   34.81 | 30-35,304-311,315,319,340-353,358-359,365-375,381-396,402-422,434-444,450-458,464-492,555-564,570-621,627-640,645-654,763-771,825,844-845,882,886,898-904,914-916                                                                                                                                                                                                                                                                                                                                                                           
 proposal-generator-v4/agents         |    47.4 |    31.21 |   61.19 |   47.57 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  assistantAgent.js                   |    4.47 |     1.56 |       0 |    4.76 | 7-14,19-253                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
  assistantDefinitions.js             |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  collaborativeAgent.js               |      25 |        0 |       0 |      25 | 9-48                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  flowAgent.js                        |   59.97 |    43.95 |      82 |   59.75 | 30-35,77-84,119-120,136-137,147-154,164-168,176-227,233,238-239,256-257,266-267,269-270,284-312,356,396-397,401-402,415,435,472-475,479-489,502-509,517-519,527-532,542,615-629,637,644-656,664-665,691-699,782-784,791-793,805-848,861-863,874,916-941,952-975,994-995,1000-1002,1007-1008,1023,1030-1032,1064,1076-1078,1089-1090,1114,1137-1138,1147-1163,1195-1196,1208-1226,1234,1250-1252,1276,1288-1289,1300-1339,1343-1357,1386,1409,1430,1442-1444,1466,1481,1503,1522,1538-1540,1546-1554,1566,1589,1598,1600,1635-1636,1667-1693 
  orchestratorAgent.js                |    10.2 |     6.06 |       0 |   10.41 | 12-82                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  proposalAgent.js                    |   16.66 |        0 |       0 |   16.66 | 10-52                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 proposal-generator-v4/db             |   36.84 |    46.87 |   13.63 |   37.83 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  index.js                            |   44.44 |     37.5 |    7.69 |   44.44 | 29-56                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  knexfile.js                         |      75 |      100 |      50 |      75 | 24                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  setup.js                            |   28.88 |    14.28 |   14.28 |   30.23 | 23-75,84,99-100                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
 proposal-generator-v4/db/migrations  |      88 |       50 |      75 |      88 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  20250521_initial_schema.js          |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  20250522_postgres_optimizations.js  |      50 |       50 |   33.33 |      50 | 12-23,33-39                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
  20250523_add_contexts_table.js      |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
 proposal-generator-v4/db/models      |    3.92 |        0 |       0 |    4.12 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  agent.js                            |    12.5 |        0 |       0 |    12.5 | 19-72                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  message.js                          |     2.5 |        0 |       0 |    2.67 | 16-281                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  session.js                          |    4.41 |        0 |       0 |    4.54 | 16-165                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
 proposal-generator-v4/routes         |   16.25 |        0 |       0 |   16.45 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  monitor.js                          |   16.25 |        0 |       0 |   16.45 | 19-39,48-58,71-101,114-122,131-136,145-150,159-182                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
 proposal-generator-v4/templates      |   11.76 |        0 |       0 |    12.5 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  defaultTemplate.js                  |   11.76 |        0 |       0 |    12.5 | 75-92                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 proposal-generator-v4/tests/fixtures |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  customerBrief.js                    |     100 |      100 |     100 |     100 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
--------------------------------------|---------|----------|---------|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Test Suites: 1 failed, 1 total
Tests:       1 failed, 1 passed, 2 total
Snapshots:   0 total
Time:        1.049 s, estimated 2 s
Ran all test suites matching /flow.test.js/i.
